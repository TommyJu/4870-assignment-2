@page "/"
@using BloggerBlazorServer.Services
@using Microsoft.AspNetCore.Components.QuickGrid
@using Microsoft.EntityFrameworkCore
@rendermode InteractiveServer

@inject ArticleService articleService
@inject NavigationManager navigationManager

<PageTitle>Home</PageTitle>

<link rel="stylesheet" href="style.css" asp-append-version="true" />

<div class="text-center">

    <div style="margin-top: 40px;">
        <h1>Recent Articles</h1>

        <p>
            <input type="text" @bind="searchString" @bind:event="oninput" placeholder="Search by article title"/>
        </p>

        @if (articles is null)
        {
            <p>Loading articles...</p>
        }
        else if (!articles.Any())
        {
            <p>No articles found.</p>
        }
        else
        {
            <QuickGrid Items="@filteredArticles" TGridItem="Article" class="table" Pagination="@pagination">
                <PropertyColumn Property="@(_ => _.Title)" />
                <PropertyColumn Property="@(_ => _.Contributor!.FirstName)" Title="First Name" />
                <PropertyColumn Property="@(_ => _.Contributor!.LastName)" Title="Last Name" />
                <PropertyColumn Property="@(_ => _.CreateDate)" Format="d" Title="Create Date" />
                <PropertyColumn Property="@(_ => _.EndDate)" Format="d" Title="End Date" />
                <TemplateColumn Title="Content">

                    <p>
                        @(context.Body != null && context.Body.Length > 100 ? context.Body.Substring(0, 100) + "..." :
                                            context.Body ?? string.Empty)
                    @if (context.Body != null && context.Body.Length > 100)
                        {
                            <a href="/readmore/@context.ArticleId" class="more-link">Read more</a>
                        }
                    </p>
                </TemplateColumn>
                <TemplateColumn Title="Actions">
                    <button class="btn btn-primary margin-2" @onclick="() => EditArticle(context.ArticleId)">
                        Edit
                    </button>
                    <button class="btn btn-danger margin-2" @onclick="() => DeleteArticle(context.ArticleId)">
                        Delete
                    </button>
                </TemplateColumn>
            </QuickGrid>
            <Paginator State="@pagination" />
        }
    </div>
</div>

@code {
    IQueryable<Article>? articles;

    private string searchString = "";

    IQueryable<Article> filteredArticles
        {
            get {
                var result = articles?.Where(a => a.Title!.Contains(searchString, StringComparison.OrdinalIgnoreCase));
                return result!;
                }
        }
    protected override async Task OnInitializedAsync()
    {
        articles = (await articleService.GetArticlesAsync()).AsQueryable();
        

        // Filter articles by date range (only show most recent articles)
        if (articles != null)
        {
            DateTime currentUtcDate = DateTime.UtcNow;

            articles = articles.Where(a => currentUtcDate >= a.StartDate && currentUtcDate < a.EndDate).AsQueryable();
        }
    }

    private void EditArticle(int articleId)
    {
        navigationManager.NavigateTo($"/edit-article/{articleId}");
    }
    private async Task DeleteArticle(int articleId)
    {
        await articleService.DeleteArticleAsync(articleId);
        await LoadArticlesAsync();
        StateHasChanged();
    }


    //To reload articles upon deletion
    private async Task LoadArticlesAsync()
{
    articles = (await articleService.GetArticlesAsync()).AsQueryable();

    if (articles != null)
    {
        DateTime currentUtcDate = DateTime.UtcNow;

        articles = articles.Where(a => currentUtcDate >= a.StartDate && currentUtcDate < a.EndDate).AsQueryable();
    }
}

    private PaginationState pagination = new PaginationState { ItemsPerPage = 5 };
}